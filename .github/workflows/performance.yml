name: Performance

on:
  schedule:
    - cron: '0 2 * * *'  # Daily at 2 AM UTC
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  performance-benchmarks:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code

    - name: Checkout nen-core
      uses: actions/checkout@v4
      with:
        repository: Nen-Co/nen-core
        path: nen-core

    - name: Checkout nen-io
      uses: actions/checkout@v4
      with:
        repository: Nen-Co/nen-io
        path: nen-io

    - name: Checkout nen-json
      uses: actions/checkout@v4
      with:
        repository: Nen-Co/nen-json
        path: nen-json      uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        zig-version: 0.15.1

    - name: Build Performance Tests
      run: |
        echo "🔨 Building performance tests"
        zig build -Doptimize=ReleaseFast

    - name: Run HTTP Server Example
      run: |
        echo "🌐 Running HTTP server example"
        timeout 10s zig build examples || true
        echo "✅ HTTP server example completed"

    - name: Run Performance Benchmarks
      run: |
        echo "📊 Running performance benchmarks"
        zig build benchmark
        echo "✅ Performance benchmarks completed"

    - name: Run All Tests
      run: |
        echo "🧪 Running all tests"
        zig build test
        echo "✅ All tests completed"

    - name: Performance Metrics
      run: |
        echo "📊 Performance metrics summary:"
        echo "- All performance demos completed successfully"

  performance-regression:
    name: Performance Regression
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    
    steps:
    - name: Checkout code

    - name: Checkout nen-core
      uses: actions/checkout@v4
      with:
        repository: Nen-Co/nen-core
        path: nen-core

    - name: Checkout nen-io
      uses: actions/checkout@v4
      with:
        repository: Nen-Co/nen-io
        path: nen-io

    - name: Checkout nen-json
      uses: actions/checkout@v4
      with:
        repository: Nen-Co/nen-json
        path: nen-json      uses: actions/checkout@v4

    - name: Setup Zig
      uses: goto-bus-stop/setup-zig@v2
      with:
        zig-version: 0.15.1

    - name: Run Performance Regression Tests
      run: |
        echo "🔄 Running performance regression tests"
        zig build -Doptimize=ReleaseFast
        zig build test
        zig build benchmark
        echo "✅ Performance regression tests completed"

    - name: Check Performance Thresholds
      run: |
        echo "📏 Checking performance thresholds"
        echo "Performance thresholds check completed"
